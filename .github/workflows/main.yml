name: CI/CD with Docker Compose

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code from GitHub repository
      - name: üõ†Ô∏è Checkout code
        uses: actions/checkout@v4
 
      # Step 3: Set up Docker Buildx
      - name: üîß Set up Docker
        uses: docker/setup-buildx-action@v3

      # Step 5: Build and push Docker image using docker-compose
      - name: üê≥ Build Docker Compose services
        uses: docker/build-push-action@v2.3.1
        with:
          context: . # path to folder containing docker-compose.yml
          file: .  # if you have a Dockerfile
          push: false  # set true if you want to push to DockerHub
          platforms: linux/amd64,linux/arm64

      # Step 6: Run Docker Compose up
      - name: üî® Start services with Docker Compose
        uses: docker/compose-action@v2
        with:
          project-name: portfolio
          files: ./portfolio/docker-compose.yml
          detached: true
          build: true
    
      # Step 7: Stop and clean up Docker services
      - name: üßπ Stop and clean up
        run: |
          docker-compose -f portfolio/docker-compose.yml down

  deploy:
    runs-on: ubuntu-latest
    needs: build  # Ensure this runs after the 'build' job

    steps:
      # Step 1: Checkout the code again for deployment
      - name: üõ†Ô∏è Checkout code for deployment
        uses: actions/checkout@v4

      # Step 2: Set up Docker on the server (optional step for deployment)
      - name: üîß Set up Docker for deployment
        run: |
          curl -fsSL https://get.docker.com | bash
          sudo usermod -aG docker $USER
          sudo systemctl enable --now docker

      # Step 3: SSH into the server and deploy (Replace with your actual server details)
      - name: üöÄ Deploy to Production (SSH to server)
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          port: 22
          script: |
            cd /path/to/your/project
            docker-compose -f portfolio/docker-compose.yml down  # Stop old containers (if any)
            docker-compose -f portfolio/docker-compose.yml up -d --build  # Build and start new containers

      # Optional: Post-deployment steps (e.g., notify, or health check)
      - name: ‚úÖ Health Check (Optional)
        run: |
          curl --fail http://localhost:3000 || exit 1  # Check if the app is running
